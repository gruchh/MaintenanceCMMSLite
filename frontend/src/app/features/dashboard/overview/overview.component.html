<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div
    class="lg:col-span-2 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm"
  >
    <div class="flex justify-between items-center">
      <h3 class="font-semibold text-lg text-gray-800 flex items-center">
        <ng-icon
          name="heroChartBar"
          class="w-5 h-5 text-blue-600 mr-2"
        ></ng-icon>
        Poziom wydajności fabryki
      </h3>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-500">Ostatnie 7 dni</span>
        <button
          (click)="refreshData()"
          class="p-1 hover:bg-gray-100 rounded-md transition-colors"
          [disabled]="isLoading()"
        >
          <ng-icon
            name="heroArrowPath"
            class="w-4 h-4 text-gray-500"
            [class.animate-spin]="isLoading()"
          ></ng-icon>
        </button>
      </div>
    </div>
    @if (isLoading()) {
    <div class="mt-4 flex items-center justify-center h-40">
      <div class="flex items-center space-x-3">
        <div
          class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
        ></div>
        <span class="text-gray-500">Ładowanie danych...</span>
      </div>
    </div>
    }
    @if (error() && !isLoading()) {
    <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
      <div class="flex items-center">
        <ng-icon
          name="heroExclamationTriangle"
          class="w-5 h-5 text-red-500 mr-2"
        ></ng-icon>
        <span class="text-red-700">{{ error() }}</span>
        <button
          (click)="refreshData()"
          class="ml-auto px-3 py-1 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded-md transition-colors"
        >
          Spróbuj ponownie
        </button>
      </div>
    </div>
    }
    @if (!isLoading() && !error()) {
    <div class="mt-4 relative">
      <div class="relative">
        <div
          class="absolute top-1/4 left-1/3 bg-blue-600 text-white p-2 rounded-lg shadow-lg text-center z-10"
        >
          <p class="text-xs font-semibold">{{ performanceSpotlightDate() }}</p>
          <p class="text-xl font-bold">
            {{ performanceSpotlightValue() }}
            <span class="text-sm font-normal">%</span>
          </p>
        </div>
        <svg
          class="w-full"
          [attr.viewBox]="'0 0 ' + viewBoxWidth + ' ' + viewBoxHeight"
          preserveAspectRatio="none"
        >
          <defs>
            <linearGradient id="perfGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#3B82F6" stop-opacity="0.25"></stop>
              <stop
                offset="100%"
                stop-color="#3B82F6"
                stop-opacity="0.05"
              ></stop>
            </linearGradient>
          </defs>

          <!-- Linia bazowa -->
          <line
            x1="0"
            [attr.y1]="viewBoxHeight - paddingBottom"
            [attr.x2]="viewBoxWidth"
            [attr.y2]="viewBoxHeight - paddingBottom"
            stroke="#E5E7EB"
            stroke-width="1"
          ></line>

          <!-- Wypełnienie pod wykresem -->
          <path
            [attr.d]="
              performancePath() +
              ' L ' +
              (viewBoxWidth - paddingX) +
              ' ' +
              (viewBoxHeight - paddingBottom) +
              ' L ' +
              paddingX +
              ' ' +
              (viewBoxHeight - paddingBottom) +
              ' Z'
            "
            fill="url(#perfGradient)"
            stroke="none"
          />

          <!-- Linia wykresu -->
          <path
            [attr.d]="performancePath()"
            fill="none"
            stroke="#3B82F6"
            stroke-width="3"
          />

          <!-- Przerywana linia średniej -->
          <line
            [attr.x1]="paddingX"
            [attr.y1]="paddingTop + (1 - avgPerformance() / 100) * (viewBoxHeight - paddingTop - paddingBottom)"
            [attr.x2]="viewBoxWidth - paddingX"
            [attr.y2]="paddingTop + (1 - avgPerformance() / 100) * (viewBoxHeight - paddingTop - paddingBottom)"
            stroke="#F59E0B"
            stroke-width="2"
            stroke-dasharray="6 4"
            opacity="0.8"
          />
          <text
            [attr.x]="viewBoxWidth - paddingX - 5"
            [attr.y]="paddingTop + (1 - avgPerformance() / 100) * (viewBoxHeight - paddingTop - paddingBottom) - 5"
            text-anchor="end"
            class="fill-amber-600 font-medium"
            dominant-baseline="bottom">
            {{ avgPerformance() }}%
          </text>
          @for (dot of performanceDotCoords(); track $index) {
            <circle
              [attr.cx]="dot.x"
              [attr.cy]="dot.y"
              r="4"
              fill="#3B82F6"
              stroke="white"
              stroke-width="2">
            </circle>
            <text
              [attr.x]="dot.x"
              [attr.y]="dot.y - 10"
              text-anchor="middle"
              class="fill-gray-600 text-xs font-medium"
              dominant-baseline="bottom">
              {{ dot.value }}%
            </text>
          }
        </svg>
      </div>
      <div class="flex justify-between text-xs text-gray-500 mt-2 px-2">
        @for (day of days(); track $index) {
        <span>{{ day }}</span>
        }
      </div>
    </div>
    <div class="mt-4 text-sm text-gray-600">
      Średnia z 7 dni: <span class="font-bold">{{ avgPerformance() }}%</span>
    </div>
    }
  </div>

  <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-sm">
    <h3 class="font-semibold text-lg text-gray-800 flex items-center">
      <ng-icon
        name="heroCog6Tooth"
        class="w-5 h-5 text-green-600 mr-2"
      ></ng-icon>
      Wskaźniki OEE
    </h3>
    <p class="text-sm text-gray-500">Efektywność maszyn w czasie.</p>
    <div class="relative flex justify-center items-center my-6 h-32">
      <svg class="w-32 h-32" viewBox="0 0 36 36">
        <path
          class="text-gray-200"
          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
        ></path>
        <path
          class="text-green-500"
          stroke-dasharray="85, 100"
          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
        ></path>
      </svg>
      <div class="absolute text-center">
        <span class="text-3xl font-bold text-gray-800">85%</span>
        <p class="text-xs text-gray-500">OEE</p>
      </div>
    </div>
    <div class="space-y-4">
      <div class="grid grid-cols-2 gap-3">
        <div
          class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"
        >
          <span class="text-sm font-medium text-gray-600 flex items-center">
            <ng-icon
              name="heroClock"
              class="w-4 h-4 mr-1 text-gray-500"
            ></ng-icon>
            MTBF (Rok)
          </span>
          <span class="text-sm font-bold text-gray-800">{{ mtbfYear }}</span>
        </div>
        <div
          class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"
        >
          <span class="text-sm font-medium text-gray-600 flex items-center">
            <ng-icon
              name="heroClock"
              class="w-4 h-4 mr-1 text-gray-500"
            ></ng-icon>
            MTBF (Miesiąc)
          </span>
          <span class="text-sm font-bold text-gray-800">{{ mtbfMonth }}</span>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div
          class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"
        >
          <span class="text-sm font-medium text-gray-600 flex items-center">
            <ng-icon
              name="heroWrenchScrewdriver"
              class="w-4 h-4 mr-1 text-gray-500"
            ></ng-icon>
            MTTR (Rok)
          </span>
          <span class="text-sm font-bold text-gray-800">{{ mttrYear }}</span>
        </div>
        <div
          class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"
        >
          <span class="text-sm font-medium text-gray-600 flex items-center">
            <ng-icon
              name="heroWrenchScrewdriver"
              class="w-4 h-4 mr-1 text-gray-500"
            ></ng-icon>
            MTTR (Miesiąc)
          </span>
          <span class="text-sm font-bold text-gray-800">{{ mttrMonth }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-sm">
    <h3 class="font-semibold text-lg text-gray-800 flex items-center">
      <ng-icon
        name="heroUserCircle"
        class="w-5 h-5 text-purple-600 mr-2"
      ></ng-icon>
      Konto pracownika
    </h3>
    <div class="flex items-center mt-4">
      <img
        class="h-16 w-16 rounded-full object-cover"
        [src]="employeeProfile.avatar"
        alt="Avatar pracownika"
      />
      <div class="ml-4">
        <p class="font-bold text-gray-800">{{ employeeProfile.name }}</p>
        <p class="text-sm text-gray-500">{{ employeeProfile.position }}</p>
      </div>
    </div>
    <div class="space-y-3 mt-6">
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
        <span class="text-sm font-medium text-gray-600">Pozostały urlop</span>
        <span class="font-bold text-gray-800"
          >{{ employeeProfile.remainingLeave }} dni</span
        >
      </div>
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
        <span class="text-sm font-medium text-gray-600">Otwarte zlecenia</span>
        <span class="font-bold text-gray-800">{{
          employeeProfile.openWorkOrders
        }}</span>
      </div>
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
        <span class="text-sm font-medium text-gray-600"
          >Najbliższe szkolenie</span
        >
        <span class="font-bold text-gray-800 text-right">{{
          employeeProfile.nextTraining
        }}</span>
      </div>
    </div>
  </div>

  <div
    class="lg:col-span-2 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm"
  >
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold text-lg text-gray-800 flex items-center">
        <ng-icon
          name="heroExclamationTriangle"
          class="w-5 h-5 text-red-600 mr-2"
        ></ng-icon>
        Pracownicy z największą liczbą awarii
      </h3>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th scope="col" class="py-3 px-6">Pracownik</th>
            <th scope="col" class="py-3 px-6">Liczba awarii</th>
            <th scope="col" class="py-3 px-6">Obszar odpowiedzialności</th>
          </tr>
        </thead>
        <tbody>
          @for (employee of employeesByFailures; track employee.name) {
          <tr class="bg-white border-b hover:bg-gray-50">
            <td
              class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap flex items-center"
            >
              <img
                class="h-8 w-8 rounded-full mr-3 object-cover"
                [src]="employee.avatar"
                alt="Avatar"
              />
              {{ employee.name }}
            </td>
            <td class="py-4 px-6 font-medium text-gray-800">
              {{ employee.failures }}
            </td>
            <td class="py-4 px-6">{{ employee.area }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
